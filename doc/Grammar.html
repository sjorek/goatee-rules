<!DOCTYPE html><html lang="en"><head><title>Grammar</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="Grammar"><meta name="groc-project-path" content="src/Grammar.coffee"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/Grammar.coffee</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>© Copyright 2013 Stephan Jorek <a href="&#109;&#97;&#x69;&#x6c;&#116;&#111;:&#115;&#116;&#101;&#x70;&#x68;&#97;&#110;&#46;&#x6a;o&#114;&#101;&#107;&#x40;&#103;&#x6d;&#97;&#105;&#108;&#x2e;&#x63;&#x6f;&#x6d;">&#115;&#116;&#101;&#x70;&#x68;&#97;&#110;&#46;&#x6a;o&#114;&#101;&#107;&#x40;&#103;&#x6d;&#97;&#105;&#108;&#x2e;&#x63;&#x6f;&#x6d;</a></p>

<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<p><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
implied. See the License for the specific language governing
permissions and limitations under the License.</p></div></div><div class="code"><div class="wrapper"><span class="p">{</span><span class="nx">Notator</span><span class="o">:</span><span class="p">{</span>
  <span class="nx">r</span><span class="p">,</span><span class="nx">o</span><span class="p">,</span><span class="nx">c</span>
<span class="p">}}</span>            <span class="o">=</span> <span class="nx">require</span> <span class="s">&#39;goatee-script/lib/Notator&#39;</span>

<span class="nv">ScriptGrammar = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;goatee-script/lib/Grammar&#39;</span><span class="p">).</span><span class="nx">Grammar</span>

<span class="p">{</span><span class="nx">Scope</span><span class="p">}</span>       <span class="o">=</span> <span class="nx">require</span> <span class="s">&#39;./Scope&#39;</span>

<span class="nv">exports = </span><span class="nx">module</span><span class="o">?</span><span class="p">.</span><span class="nx">exports</span> <span class="o">?</span> <span class="k">this</span>

<span class="nv">exports.Grammar = </span><span class="k">class</span> <span class="nx">Grammar</span> <span class="k">extends</span> <span class="nx">ScriptGrammar</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Actually this is not needed, but it looks nicer ;-)</p></div></div><div class="code"><div class="wrapper">  <span class="nv">$1 = $2 = $3 = $4 = $5 = $6 = $7 = $8 = </span><span class="kc">null</span>

  <span class="nv">yy = </span><span class="k">new</span> <span class="nx">Scope</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'></span></p>

<p>#
Initializes the <strong>Parser</strong> with our <strong>Grammar</strong></p>

<p>Parameters:</p>

<ul>
<li><p><strong>grammar must be a Grammar.</strong></p></li>
<li><p><strong>scope must be a Scope.</strong></p></li>
</ul>

<p><strong>Returns a Parser</strong></p></div></div><div class="code"><div class="wrapper">  <span class="nv">Grammar.createParser = </span><span class="nf">(grammar = new Grammar, scope = yy) -&gt;</span>
    <span class="nx">ScriptGrammar</span><span class="p">.</span><span class="nx">createParser</span> <span class="nx">grammar</span><span class="p">,</span> <span class="nx">scope</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'></span></p>

<p>#
Create and return the parsers source code wrapped into a closure, still
keeping the value of <code>this</code>.</p>

<p><strong>Returns a String</strong></p></div></div><div class="code"><div class="wrapper">  <span class="nv">create: </span><span class="p">(</span><span class="nv">comment  = </span><span class="s">&#39;Goatee Rules Parser&#39;</span><span class="p">,</span> <span class="nv">prefix   = </span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="o">\</span>
           <span class="nv">suffix   = </span><span class="s">&#39;parser.yy = new (require(&quot;./Scope&quot;).Scope);&#39;</span><span class="p">)</span> <span class="nf">-&gt;</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">comment</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">suffix</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Use the default jison-lexer</p></div></div><div class="code"><div class="wrapper">  <span class="nv">lex: </span><span class="nx">do</span> <span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Declare all lexer tokens</p></div></div><div class="code"><div class="wrapper">    <span class="nv">rules = </span><span class="p">[</span>
      <span class="nx">r</span> <span class="sr">///</span>
<span class="sr">        (</span>
<span class="sr">          [_a-zA-Z]     |</span>
<span class="sr">          [-_][_a-zA-Z]</span>
<span class="sr">        )</span>
<span class="sr">        (</span>
<span class="sr">          -?\w</span>
<span class="sr">        )*</span>
<span class="sr">      ///</span>                             <span class="p">,</span> <span class="nf">-&gt;</span> <span class="s">&#39;KEY&#39;</span>
      <span class="nx">c</span> <span class="p">[</span><span class="s">&#39;rule&#39;</span><span class="p">],</span> <span class="sr">/\s\!important\b/</span>   <span class="p">,</span> <span class="nf">-&gt;</span> <span class="s">&#39;NONIMPORTANT&#39;</span>
      <span class="nx">r</span> <span class="s">&#39;:&#39;</span>                           <span class="p">,</span> <span class="nf">-&gt;</span> <span class="nx">@begin</span> <span class="s">&#39;rule&#39;</span> <span class="p">;</span> <span class="s">&#39;:&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Inherit lexer tokens from ScriptGrammar</p></div></div><div class="code"><div class="wrapper">    <span class="p">].</span><span class="nx">concat</span> <span class="nx">ScriptGrammar</span><span class="o">::</span><span class="nx">lex</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(v, k) -&gt;</span>
      <span class="k">switch</span> <span class="nx">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>'\s+', '/* … */'</p></div></div><div class="code"><div class="wrapper">        <span class="k">when</span> <span class="s">&#39;return;&#39;</span>
          <span class="p">[[</span><span class="s">&#39;*&#39;</span><span class="p">]].</span><span class="nx">concat</span> <span class="nx">v</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>';', 'EOF'</p></div></div><div class="code"><div class="wrapper">        <span class="k">when</span> <span class="s">&#39;return \&#39;;\&#39;;&#39;</span><span class="p">,</span> <span class="s">&#39;return \&#39;EOF\&#39;;&#39;</span>
          <span class="nx">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;this.popState();&#39;</span> <span class="o">+</span> <span class="nx">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
          <span class="p">[[</span><span class="s">&#39;*&#39;</span><span class="p">]].</span><span class="nx">concat</span> <span class="nx">v</span>
        <span class="k">else</span> <span class="p">[[</span><span class="s">&#39;rule&#39;</span><span class="p">]].</span><span class="nx">concat</span> <span class="nx">v</span>

    <span class="p">{</span>
      <span class="nv">startConditions :</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>“rule” is implicit (1), not explicit (0)</p></div></div><div class="code"><div class="wrapper">        <span class="nv">rule          : </span><span class="mi">1</span>
      <span class="nv">rules           : </span><span class="nx">rules</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The <strong>Rules</strong> is the top-level node in the syntax tree.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">startSymbol : </span><span class="s">&#39;Rules&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>#</p>

<h2 id="the-syntax-description-notated-in-backus-naur-format">The syntax description notated in Backus-Naur-Format</h2></div></div><div class="code"><div class="wrapper">  <span class="nv">bnf: </span><span class="nx">do</span> <span class="nf">-&gt;</span>

    <span class="nv">grammar =</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Since we parse bottom-up, all parsing must end here.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">Rules: </span><span class="p">[</span>
        <span class="nx">r</span> <span class="s">&#39;End&#39;</span>                       <span class="p">,</span> <span class="nf">-&gt;</span> <span class="nx">yy</span><span class="p">.</span><span class="nx">create</span> <span class="s">&#39;scalar&#39;</span><span class="p">,</span> <span class="p">[</span><span class="kc">undefined</span><span class="p">]</span>
        <span class="nx">r</span> <span class="s">&#39;RuleMap End&#39;</span>               <span class="p">,</span> <span class="nf">-&gt;</span> <span class="nx">$1</span>
        <span class="nx">r</span> <span class="s">&#39;Seperator RuleMap End&#39;</span>     <span class="p">,</span> <span class="nf">-&gt;</span> <span class="nx">$2</span>
      <span class="p">]</span>
      <span class="nv">RuleMap: </span><span class="p">[</span>
        <span class="nx">o</span> <span class="s">&#39;Map&#39;</span>                       <span class="p">,</span> <span class="nf">-&gt;</span> <span class="nx">yy</span><span class="p">.</span><span class="nx">create</span> <span class="s">&#39;rules&#39;</span><span class="p">,</span> <span class="nx">$1</span>
        <span class="nx">o</span> <span class="s">&#39;RuleMap Seperator Map&#39;</span>     <span class="p">,</span> <span class="nf">-&gt;</span> <span class="nx">yy</span><span class="p">.</span><span class="nx">addRule</span> <span class="nx">$1</span><span class="p">,</span> <span class="nx">$3</span>
      <span class="p">]</span>
      <span class="nv">Map: </span><span class="p">[</span>
        <span class="nx">o</span> <span class="s">&#39;KEY : Rule&#39;</span>                <span class="p">,</span> <span class="nf">-&gt;</span> <span class="p">[</span><span class="nx">$1</span><span class="p">].</span><span class="nx">concat</span> <span class="nx">$3</span>
      <span class="p">]</span>
      <span class="nv">Rule: </span><span class="p">[</span>
        <span class="nx">o</span> <span class="s">&#39;List&#39;</span>                      <span class="p">,</span> <span class="nf">-&gt;</span> <span class="p">[</span><span class="nx">$1</span><span class="p">,</span> <span class="kc">off</span><span class="p">]</span>
        <span class="nx">o</span> <span class="s">&#39;List NONIMPORTANT&#39;</span>         <span class="p">,</span> <span class="nf">-&gt;</span> <span class="p">[</span><span class="nx">$1</span><span class="p">,</span> <span class="kc">on</span><span class="p">]</span>
      <span class="p">]</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Inherit all but “Script” and “Statement” operations from ScriptGrammar</p></div></div><div class="code"><div class="wrapper">    <span class="k">for</span> <span class="k">own</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">ScriptGrammar</span><span class="o">::</span><span class="nx">bnf</span> <span class="k">when</span> <span class="nx">k</span> <span class="o">isnt</span> <span class="s">&#39;Script&#39;</span> <span class="o">and</span> <span class="nx">k</span> <span class="o">isnt</span> <span class="s">&#39;Statements&#39;</span>
      <span class="k">if</span> <span class="nx">k</span> <span class="o">isnt</span> <span class="s">&#39;Operation&#39;</span>
        <span class="nx">grammar</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
        <span class="k">continue</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Tweak “Operation” to include a hack to support “!important” as statement
expression without interfering the final “!important” declaration</p></div></div><div class="code"><div class="wrapper">      <span class="nv">ops = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">rule</span> <span class="k">in</span> <span class="nx">v</span>
        <span class="k">if</span> <span class="nx">rule</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;! Expression&#39;</span>
          <span class="nx">ops</span><span class="p">.</span><span class="nx">push</span> <span class="nx">o</span> <span class="s">&#39;NONIMPORTANT&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
            <span class="nx">yy</span><span class="p">.</span><span class="nx">create</span> <span class="s">&#39;!&#39;</span> <span class="p">,</span> <span class="p">[</span>
              <span class="nx">yy</span><span class="p">.</span><span class="nx">create</span> <span class="s">&#39;reference&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;important&#39;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="nx">ops</span><span class="p">.</span><span class="nx">push</span> <span class="nx">rule</span>

      <span class="nx">grammar</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ops</span>

    <span class="nx">grammar</span></div></div></div></div></body></html>